<template><div><nav class="table-of-contents"><ul><li><router-link to="#websocket-配置">WebSocket 配置</router-link><ul><li><router-link to="#_1-安装依赖">1. 安装依赖</router-link></li><li><router-link to="#_2-创建-websocket-网关">2. 创建 WebSocket 网关</router-link></li></ul></li><li><router-link to="#消息服务实现">消息服务实现</router-link><ul><li><router-link to="#_1-消息实体">1. 消息实体</router-link></li><li><router-link to="#_2-消息服务">2. 消息服务</router-link></li></ul></li><li><router-link to="#通知服务实现">通知服务实现</router-link><ul><li><router-link to="#_1-通知实体">1. 通知实体</router-link></li><li><router-link to="#_2-通知服务">2. 通知服务</router-link></li></ul></li><li><router-link to="#在线状态管理">在线状态管理</router-link><ul><li><router-link to="#_1-创建在线状态服务">1. 创建在线状态服务</router-link></li></ul></li><li><router-link to="#下一步">下一步</router-link></li></ul></nav>
<h1 id="nestjs-websocket-实时通信" tabindex="-1"><a class="header-anchor" href="#nestjs-websocket-实时通信"><span>NestJS WebSocket 实时通信</span></a></h1>
<h2 id="websocket-配置" tabindex="-1"><a class="header-anchor" href="#websocket-配置"><span>WebSocket 配置</span></a></h2>
<h3 id="_1-安装依赖" tabindex="-1"><a class="header-anchor" href="#_1-安装依赖"><span>1. 安装依赖</span></a></h3>
<div class="language-bash line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff" v-pre=" language-bash"><code><span class="line"><span class="line"><span style="color:#616E88"># 安装 WebSocket 相关依赖</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">npm</span><span style="color:#A3BE8C"> install</span><span style="color:#A3BE8C"> @nestjs/websockets</span><span style="color:#A3BE8C"> @nestjs/platform-socket.io</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">npm</span><span style="color:#A3BE8C"> install</span><span style="color:#A3BE8C"> -D</span><span style="color:#A3BE8C"> @types/socket.io</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-创建-websocket-网关" tabindex="-1"><a class="header-anchor" href="#_2-创建-websocket-网关"><span>2. 创建 WebSocket 网关</span></a></h3>
<p>创建 <code v-pre>src/modules/websocket/websocket.gateway.ts</code>：</p>
<div class="language-typescript line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff" v-pre=" language-typescript"><code><span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  WebSocketGateway</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  WebSocketServer</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  SubscribeMessage</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  OnGatewayConnection</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  OnGatewayDisconnect</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  OnGatewayInit</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">@nestjs/websockets</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> Server</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> Socket</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">socket.io</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> Logger</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">@nestjs/common</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">@WebSocketGateway</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  cors</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">    origin</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">*</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  },</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">export</span><span style="color:#81A1C1"> class</span><span style="color:#8FBCBB"> WebsocketGateway</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  implements</span><span style="color:#8FBCBB;font-weight:bold"> OnGatewayInit</span><span style="color:#ECEFF4">,</span><span style="color:#8FBCBB;font-weight:bold"> OnGatewayConnection</span><span style="color:#ECEFF4">,</span><span style="color:#8FBCBB;font-weight:bold"> OnGatewayDisconnect</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">{</span></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @WebSocketServer</span><span style="color:#D8DEE9FF">() server</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Server</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  private</span><span style="color:#D8DEE9FF"> logger</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Logger</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> new</span><span style="color:#88C0D0"> Logger</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">WebsocketGateway</span><span style="color:#ECEFF4">"</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  private</span><span style="color:#D8DEE9FF"> connectedClients</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Map</span><span style="color:#ECEFF4">&#x3C;</span><span style="color:#8FBCBB">string</span><span style="color:#ECEFF4">,</span><span style="color:#8FBCBB"> Socket</span><span style="color:#ECEFF4">></span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> new</span><span style="color:#88C0D0"> Map</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  afterInit</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">server</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Server</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">logger</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">WebSocket 服务器初始化完成</span><span style="color:#ECEFF4">"</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  handleConnection</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">client</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Socket</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">logger</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">客户端连接: </span><span style="color:#ECEFF4">${</span><span style="color:#D8DEE9">client</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">connectedClients</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">client</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> client</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  handleDisconnect</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">client</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Socket</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">logger</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">客户端断开连接: </span><span style="color:#ECEFF4">${</span><span style="color:#D8DEE9">client</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">}`</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">connectedClients</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">delete</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">client</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">id</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @SubscribeMessage</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">join</span><span style="color:#ECEFF4">"</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  handleJoin</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">client</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Socket</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> payload</span><span style="color:#81A1C1">:</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9FF"> userId</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4"> })</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">    client</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">join</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">payload</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">userId</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">logger</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">用户 </span><span style="color:#ECEFF4">${</span><span style="color:#D8DEE9">payload</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">userId</span><span style="color:#ECEFF4">}</span><span style="color:#A3BE8C"> 加入房间</span><span style="color:#ECEFF4">`</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @SubscribeMessage</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">leave</span><span style="color:#ECEFF4">"</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  handleLeave</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">client</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Socket</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> payload</span><span style="color:#81A1C1">:</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9FF"> userId</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4"> })</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">    client</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">leave</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">payload</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">userId</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">logger</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">log</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">`</span><span style="color:#A3BE8C">用户 </span><span style="color:#ECEFF4">${</span><span style="color:#D8DEE9">payload</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">userId</span><span style="color:#ECEFF4">}</span><span style="color:#A3BE8C"> 离开房间</span><span style="color:#ECEFF4">`</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @SubscribeMessage</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">message</span><span style="color:#ECEFF4">"</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  handleMessage</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">client</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Socket</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> payload</span><span style="color:#81A1C1">:</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9FF"> to</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#81A1C1">;</span><span style="color:#D8DEE9FF"> message</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> any</span><span style="color:#ECEFF4"> })</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">server</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">to</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">payload</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">to</span><span style="color:#D8DEE9FF">)</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">emit</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">message</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">,</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      from</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9"> client</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      message</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9"> payload</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">message</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    }</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88">  // 广播消息给所有客户端</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  broadcastMessage</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">event</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> message</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> any</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">server</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">emit</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">event</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> message</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88">  // 发送消息给特定用户</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  sendToUser</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">userId</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> event</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> message</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> any</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">server</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">to</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">userId</span><span style="color:#D8DEE9FF">)</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">emit</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">event</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> message</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="消息服务实现" tabindex="-1"><a class="header-anchor" href="#消息服务实现"><span>消息服务实现</span></a></h2>
<h3 id="_1-消息实体" tabindex="-1"><a class="header-anchor" href="#_1-消息实体"><span>1. 消息实体</span></a></h3>
<p>创建 <code v-pre>src/modules/message/entities/message.entity.ts</code>：</p>
<div class="language-typescript line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff" v-pre=" language-typescript"><code><span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  Entity</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  Column</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  PrimaryGeneratedColumn</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  CreateDateColumn</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  ManyToOne</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">typeorm</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> User</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">../../user/entities/user.entity</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">@Entity</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">messages</span><span style="color:#ECEFF4">"</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">export</span><span style="color:#81A1C1"> class</span><span style="color:#8FBCBB"> Message</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @PrimaryGeneratedColumn</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">uuid</span><span style="color:#ECEFF4">"</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  id</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @Column</span><span style="color:#D8DEE9FF">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  content</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @Column</span><span style="color:#D8DEE9FF">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  type</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @ManyToOne</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1"> =></span><span style="color:#D08770"> User</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  sender</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> User</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @ManyToOne</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1"> =></span><span style="color:#D08770"> User</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  receiver</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> User</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @Column</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9"> default</span><span style="color:#ECEFF4">:</span><span style="color:#81A1C1"> false</span><span style="color:#ECEFF4"> }</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  isRead</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> boolean</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @CreateDateColumn</span><span style="color:#D8DEE9FF">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  createdAt</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Date</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-消息服务" tabindex="-1"><a class="header-anchor" href="#_2-消息服务"><span>2. 消息服务</span></a></h3>
<p>创建 <code v-pre>src/modules/message/message.service.ts</code>：</p>
<div class="language-typescript line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff" v-pre=" language-typescript"><code><span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> Injectable</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">@nestjs/common</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> InjectRepository</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">@nestjs/typeorm</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> Repository</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">typeorm</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> Message</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">./entities/message.entity</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> CreateMessageDto</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">./dto/create-message.dto</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> WebsocketGateway</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">../websocket/websocket.gateway</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">@Injectable</span><span style="color:#D8DEE9FF">()</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">export</span><span style="color:#81A1C1"> class</span><span style="color:#8FBCBB"> MessageService</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  constructor</span><span style="color:#ECEFF4">(</span></span></span>
<span class="line"><span class="line"><span style="color:#D08770">    @InjectRepository</span><span style="color:#D8DEE9FF">(</span><span style="color:#D08770">Message</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    private</span><span style="color:#81A1C1"> readonly</span><span style="color:#D8DEE9"> messageRepository</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Repository</span><span style="color:#ECEFF4">&#x3C;</span><span style="color:#8FBCBB">Message</span><span style="color:#ECEFF4">>,</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    private</span><span style="color:#81A1C1"> readonly</span><span style="color:#D8DEE9"> websocketGateway</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> WebsocketGateway</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  )</span><span style="color:#ECEFF4"> {}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  async</span><span style="color:#88C0D0"> create</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">createMessageDto</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> CreateMessageDto</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Promise</span><span style="color:#ECEFF4">&#x3C;</span><span style="color:#8FBCBB">Message</span><span style="color:#ECEFF4">></span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    const</span><span style="color:#D8DEE9"> message</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">messageRepository</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">create</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">createMessageDto</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    const</span><span style="color:#D8DEE9"> savedMessage</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> await</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">messageRepository</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">save</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">message</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88">    // 发送实时消息</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">websocketGateway</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">sendToUser</span><span style="color:#D8DEE9FF">(</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      createMessageDto</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">receiver</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">      "</span><span style="color:#A3BE8C">newMessage</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      savedMessage</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">    )</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    return</span><span style="color:#D8DEE9"> savedMessage</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  async</span><span style="color:#88C0D0"> findAll</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">userId</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Promise</span><span style="color:#ECEFF4">&#x3C;</span><span style="color:#8FBCBB">Message</span><span style="color:#D8DEE9FF">[]</span><span style="color:#ECEFF4">></span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    return</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">messageRepository</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">find</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      where</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> [</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9"> sender</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> id</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9"> userId</span><span style="color:#ECEFF4"> }</span><span style="color:#ECEFF4"> },</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> receiver</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> id</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9"> userId</span><span style="color:#ECEFF4"> }</span><span style="color:#ECEFF4"> }</span><span style="color:#D8DEE9FF">]</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      relations</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> [</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">sender</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">,</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">receiver</span><span style="color:#ECEFF4">"</span><span style="color:#D8DEE9FF">]</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      order</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">        createdAt</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">DESC</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">      },</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    }</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  async</span><span style="color:#88C0D0"> markAsRead</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">messageId</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Promise</span><span style="color:#ECEFF4">&#x3C;</span><span style="color:#8FBCBB">Message</span><span style="color:#ECEFF4">></span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    const</span><span style="color:#D8DEE9"> message</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> await</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">messageRepository</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">findOne</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      where</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> id</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9"> messageId</span><span style="color:#ECEFF4"> },</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    }</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">    message</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">isRead</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    return</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">messageRepository</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">save</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">message</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="通知服务实现" tabindex="-1"><a class="header-anchor" href="#通知服务实现"><span>通知服务实现</span></a></h2>
<h3 id="_1-通知实体" tabindex="-1"><a class="header-anchor" href="#_1-通知实体"><span>1. 通知实体</span></a></h3>
<p>创建 <code v-pre>src/modules/notification/entities/notification.entity.ts</code>：</p>
<div class="language-typescript line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff" v-pre=" language-typescript"><code><span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  Entity</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  Column</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  PrimaryGeneratedColumn</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  CreateDateColumn</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">  ManyToOne</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">typeorm</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> User</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">../../user/entities/user.entity</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">@Entity</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">notifications</span><span style="color:#ECEFF4">"</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">export</span><span style="color:#81A1C1"> class</span><span style="color:#8FBCBB"> Notification</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @PrimaryGeneratedColumn</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">uuid</span><span style="color:#ECEFF4">"</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  id</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @Column</span><span style="color:#D8DEE9FF">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  type</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @Column</span><span style="color:#D8DEE9FF">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  content</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @ManyToOne</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1"> =></span><span style="color:#D08770"> User</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  user</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> User</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @Column</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span><span style="color:#D8DEE9"> default</span><span style="color:#ECEFF4">:</span><span style="color:#81A1C1"> false</span><span style="color:#ECEFF4"> }</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  isRead</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> boolean</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">  @CreateDateColumn</span><span style="color:#D8DEE9FF">()</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">  createdAt</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Date</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-通知服务" tabindex="-1"><a class="header-anchor" href="#_2-通知服务"><span>2. 通知服务</span></a></h3>
<p>创建 <code v-pre>src/modules/notification/notification.service.ts</code>：</p>
<div class="language-typescript line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff" v-pre=" language-typescript"><code><span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> Injectable</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">@nestjs/common</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> InjectRepository</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">@nestjs/typeorm</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> Repository</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">typeorm</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> Notification</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">./entities/notification.entity</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> CreateNotificationDto</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">./dto/create-notification.dto</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> WebsocketGateway</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">../websocket/websocket.gateway</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">@Injectable</span><span style="color:#D8DEE9FF">()</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">export</span><span style="color:#81A1C1"> class</span><span style="color:#8FBCBB"> NotificationService</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  constructor</span><span style="color:#ECEFF4">(</span></span></span>
<span class="line"><span class="line"><span style="color:#D08770">    @InjectRepository</span><span style="color:#D8DEE9FF">(</span><span style="color:#D08770">Notification</span><span style="color:#D8DEE9FF">)</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    private</span><span style="color:#81A1C1"> readonly</span><span style="color:#D8DEE9"> notificationRepository</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Repository</span><span style="color:#ECEFF4">&#x3C;</span><span style="color:#8FBCBB">Notification</span><span style="color:#ECEFF4">>,</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    private</span><span style="color:#81A1C1"> readonly</span><span style="color:#D8DEE9"> websocketGateway</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> WebsocketGateway</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  )</span><span style="color:#ECEFF4"> {}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  async</span><span style="color:#88C0D0"> create</span><span style="color:#ECEFF4">(</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">    createNotificationDto</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> CreateNotificationDto</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  )</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Promise</span><span style="color:#ECEFF4">&#x3C;</span><span style="color:#8FBCBB">Notification</span><span style="color:#ECEFF4">></span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    const</span><span style="color:#D8DEE9"> notification</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">notificationRepository</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">create</span><span style="color:#D8DEE9FF">(</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      createNotificationDto</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">    )</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    const</span><span style="color:#D8DEE9"> savedNotification</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> await</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">notificationRepository</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">save</span><span style="color:#D8DEE9FF">(</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      notification</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">    )</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88">    // 发送实时通知</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">websocketGateway</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">sendToUser</span><span style="color:#D8DEE9FF">(</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      createNotificationDto</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">user</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">id</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">      "</span><span style="color:#A3BE8C">newNotification</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      savedNotification</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF">    )</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    return</span><span style="color:#D8DEE9"> savedNotification</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  async</span><span style="color:#88C0D0"> findAll</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">userId</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Promise</span><span style="color:#ECEFF4">&#x3C;</span><span style="color:#8FBCBB">Notification</span><span style="color:#D8DEE9FF">[]</span><span style="color:#ECEFF4">></span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    return</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">notificationRepository</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">find</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      where</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> user</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> id</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9"> userId</span><span style="color:#ECEFF4"> }</span><span style="color:#ECEFF4"> },</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      relations</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9FF"> [</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">user</span><span style="color:#ECEFF4">"</span><span style="color:#D8DEE9FF">]</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      order</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">        createdAt</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">DESC</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">      },</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    }</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  async</span><span style="color:#88C0D0"> markAsRead</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">notificationId</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Promise</span><span style="color:#ECEFF4">&#x3C;</span><span style="color:#8FBCBB">Notification</span><span style="color:#ECEFF4">></span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    const</span><span style="color:#D8DEE9"> notification</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> await</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">notificationRepository</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">findOne</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">{</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      where</span><span style="color:#ECEFF4">:</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> id</span><span style="color:#ECEFF4">:</span><span style="color:#D8DEE9"> notificationId</span><span style="color:#ECEFF4"> },</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    }</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">    notification</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">isRead</span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    return</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">notificationRepository</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">save</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">notification</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="在线状态管理" tabindex="-1"><a class="header-anchor" href="#在线状态管理"><span>在线状态管理</span></a></h2>
<h3 id="_1-创建在线状态服务" tabindex="-1"><a class="header-anchor" href="#_1-创建在线状态服务"><span>1. 创建在线状态服务</span></a></h3>
<p>创建 <code v-pre>src/modules/websocket/online-status.service.ts</code>：</p>
<div class="language-typescript line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre  class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff" v-pre=" language-typescript"><code><span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> Injectable</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">@nestjs/common</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">import</span><span style="color:#ECEFF4"> {</span><span style="color:#D8DEE9"> WebsocketGateway</span><span style="color:#ECEFF4"> }</span><span style="color:#81A1C1"> from</span><span style="color:#ECEFF4"> "</span><span style="color:#A3BE8C">./websocket.gateway</span><span style="color:#ECEFF4">"</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D08770">@Injectable</span><span style="color:#D8DEE9FF">()</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">export</span><span style="color:#81A1C1"> class</span><span style="color:#8FBCBB"> OnlineStatusService</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  private</span><span style="color:#D8DEE9FF"> onlineUsers</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> Map</span><span style="color:#ECEFF4">&#x3C;</span><span style="color:#8FBCBB">string</span><span style="color:#ECEFF4">,</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">></span><span style="color:#81A1C1"> =</span><span style="color:#81A1C1"> new</span><span style="color:#88C0D0"> Map</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span><span style="color:#616E88"> // userId -> socketId</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  constructor</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">private</span><span style="color:#81A1C1"> readonly</span><span style="color:#D8DEE9"> websocketGateway</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> WebsocketGateway</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  setUserOnline</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">userId</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> socketId</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">onlineUsers</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">set</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">userId</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9"> socketId</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">broadcastOnlineStatus</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  setUserOffline</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">userId</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">)</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">onlineUsers</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">delete</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">userId</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">broadcastOnlineStatus</span><span style="color:#D8DEE9FF">()</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  isUserOnline</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9">userId</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> boolean</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    return</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">onlineUsers</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">has</span><span style="color:#D8DEE9FF">(</span><span style="color:#D8DEE9">userId</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0">  getOnlineUsers</span><span style="color:#ECEFF4">()</span><span style="color:#81A1C1">:</span><span style="color:#8FBCBB"> string</span><span style="color:#D8DEE9FF">[] </span><span style="color:#ECEFF4">{</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    return</span><span style="color:#D8DEE9"> Array</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">from</span><span style="color:#D8DEE9FF">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">onlineUsers</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">keys</span><span style="color:#D8DEE9FF">())</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">  private</span><span style="color:#88C0D0"> broadcastOnlineStatus</span><span style="color:#ECEFF4">()</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1">    this</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9">websocketGateway</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">broadcastMessage</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">"</span><span style="color:#A3BE8C">onlineStatus</span><span style="color:#ECEFF4">"</span><span style="color:#ECEFF4">,</span><span style="color:#ECEFF4"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9">      onlineUsers</span><span style="color:#ECEFF4">:</span><span style="color:#81A1C1"> this</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">getOnlineUsers</span><span style="color:#D8DEE9FF">()</span><span style="color:#ECEFF4">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">    }</span><span style="color:#D8DEE9FF">)</span><span style="color:#81A1C1">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">  }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4">}</span></span></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="下一步" tabindex="-1"><a class="header-anchor" href="#下一步"><span>下一步</span></a></h2>
<p>在下一篇文章中，我们将介绍：</p>
<ol>
<li>API 文档配置</li>
<li>Swagger 集成</li>
<li>接口测试</li>
<li>文档生成</li>
</ol>
<p>敬请期待！</p>
</div></template>


